<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Área Privada - Focus Club Vallecas</title>
    <link rel="icon" type="image/jpeg" href="./img/logo.jpg">

    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" href="./dashboard.css">
    <style>
        #loadingOverlay {
            position: fixed;
            inset: 0;
            background: #0a0a0a;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 20px;
            transition: opacity 0.5s ease;
        }

        /* Extra styles for Mis Citas */
        .cita-card {
            background: rgba(30, 30, 30, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s ease;
        }

        .cita-card:hover {
            background: rgba(40, 40, 40, 0.8);
            transform: translateX(5px);
            border-color: rgba(76, 175, 80, 0.3);
        }

        .cita-date {
            font-family: var(--font-display);
            font-size: 1.2rem;
            color: var(--white);
        }

        .cita-info {
            color: #aaa;
            font-size: 0.9rem;
        }

        .btn-cancel {
            background: rgba(244, 67, 54, 0.1);
            color: #f44336;
            border: 1px solid rgba(244, 67, 54, 0.2);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .btn-cancel:hover {
            background: rgba(244, 67, 54, 0.2);
            transform: scale(1.05);
        }

        /* Time Slot States */
        .time-slot.full {
            background: rgba(255, 50, 50, 0.05) !important;
            border-color: rgba(255, 50, 50, 0.2) !important;
            color: #ff4d4d !important;
            cursor: not-allowed !important;
            opacity: 0.8;
        }

        .time-slot.user-booked {
            background: rgba(76, 175, 80, 0.1) !important;
            border-color: var(--green-glow) !important;
            color: var(--green-glow) !important;
            cursor: default !important;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.1);
        }
    </style>
</head>

<body style="opacity: 1;"> <!-- Opacity handled by overlay now -->

    <!-- Loading Screen -->
    <div id="loadingOverlay">
        <div class="logo-text" style="font-size: 2rem;">FOCUS <span>CLUB</span></div>
        <div class="spinner"
            style="width: 40px; height: 40px; border-width: 3px; border-color: var(--green-glow) transparent transparent transparent; border-radius: 50%; animation: spin 1s linear infinite;">
        </div>
        <style>
            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }

                100% {
                    transform: rotate(360deg);
                }
            }
        </style>
    </div>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <div class="dashboard-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo-text">FOCUS <span>CLUB</span></div>
                <button class="close-sidebar-btn" onclick="toggleSidebar()"><i class="fa-solid fa-times"></i></button>
            </div>

            <nav class="sidebar-nav">
                <div class="section-label">Principal</div>
                <a href="#" id="nav-inicio" class="nav-item active"
                    onclick="switchTab('inicio', this); closeSidebar(); return false;">
                    <i class="fa-solid fa-home"></i> Inicio
                </a>

                <div class="section-label" style="margin-top: 20px;">Gestión</div>
                <a href="#" id="nav-reservas" class="nav-item"
                    onclick="switchTab('reservas', this); closeSidebar(); return false;">
                    <i class="fa-solid fa-calendar-check"></i> Reservas
                </a>
                <a href="#" id="nav-planes" class="nav-item"
                    onclick="switchTab('planes', this); closeSidebar(); return false;">
                    <i class="fa-solid fa-dumbbell"></i> Planes
                </a>
                <a href="#" id="nav-pagos" class="nav-item"
                    onclick="switchTab('pagos', this); closeSidebar(); return false;">
                    <i class="fa-solid fa-credit-card"></i> Pagos
                </a>

                <div class="section-label" style="margin-top: 20px;">Cuenta</div>
                <a href="#" id="nav-perfil" class="nav-item"
                    onclick="switchTab('perfil', this); closeSidebar(); return false;">
                    <i class="fa-solid fa-user"></i> Perfil
                </a>
            </nav>

            <div class="sidebar-footer">
                <div class="user-mini">
                    <div class="user-avatar" id="userAvatar">?</div>
                    <div class="user-info">
                        <h4 id="userName">Cargando...</h4>
                        <span>Miembro activo</span>
                    </div>
                    <a href="#" id="logoutBtn"
                        style="margin-left: auto; color: var(--gray-light); transition: color 0.3s;"
                        onmouseover="this.style.color='white'" onmouseout="this.style.color='var(--gray-light)'"><i
                            class="fa-solid fa-sign-out"></i></a>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">

            <!-- INICIO Tab -->
            <div id="inicio" class="section-content active">
                <div class="top-bar">
                    <button class="mobile-menu-btn" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></button>
                    <div>
                        <div style="font-size: 0.9rem; color: var(--gray-light); margin-bottom: 5px;">Bienvenido de
                            nuevo</div>
                        <h1 class="page-title">Juan Pérez</h1>
                    </div>
                    <button class="btn btn-primary" onclick="switchTab('reservas')"
                        style="margin-left: auto; white-space: nowrap;">
                        <i class="fa-solid fa-plus" style="margin-right: 8px;"></i> Reservar
                    </button>
                </div>

                <div class="dashboard-grid">
                    <!-- Active Plan -->
                    <div class="card stat-card">
                        <div>
                            <div class="stat-label">Plan Actual</div>
                            <div class="stat-value">Bono Mensual</div>
                            <div class="status-badge status-active">
                                <span class="status-dot"></span> Activo
                            </div>
                        </div>
                        <div class="icon-box" style="background: rgba(76,175,80,0.1); color: var(--green-glow);">
                            <i class="fa-solid fa-dumbbell"></i>
                        </div>
                    </div>

                    <!-- Next Session -->
                    <div class="card stat-card">
                        <div>
                            <div class="stat-label">Próxima Sesión</div>
                            <div class="stat-value" id="next-session-time">Mañana 10:00</div>
                            <div id="next-session-info" style="color: #ccc; font-size: 0.9rem;"><i
                                    class="fa-regular fa-clock" style="margin-right: 5px;"></i> Hipertrofia con Sandra
                            </div>
                        </div>
                        <div class="icon-box" style="background: rgba(33,150,243,0.1); color: #2196F3;">
                            <i class="fa-solid fa-calendar"></i>
                        </div>
                    </div>

                    <!-- Sessions Left -->
                    <div class="card stat-card">
                        <div>
                            <div class="stat-label">Sesiones Restantes</div>
                            <div class="stat-value" id="sessions-remaining">3 <span
                                    style="font-size: 1.5rem; color: #666; font-weight: 300;">/
                                    4</span></div>
                            <div class="stat-label" style="font-size: 0.75rem; margin-top: 5px;">Renueva: 15 Feb</div>
                        </div>
                        <div class="icon-box" style="background: rgba(255,152,0,0.1); color: #ff9800;">
                            <i class="fa-solid fa-chart-pie"></i>
                        </div>
                    </div>
                </div>

                <!-- MIS CITAS Section -->
                <h3
                    style="margin-bottom: 25px; font-family: var(--font-display); font-size: 1.5rem; color: var(--white); letter-spacing: 1px;">
                    Mis Próximas Citas
                </h3>
                <div id="mis-citas-container" style="margin-bottom: 50px; display: grid; gap: 15px;">
                    <!-- JS will populate this -->
                    <div
                        style="display: flex; align-items: center; justify-content: center; text-align: center; color: rgba(255,255,255,0.2); padding: 40px; background: rgba(255,255,255,0.01); border-radius: 16px; min-height: 150px;">
                        <p style="margin: 0; font-size: 0.9rem; font-weight: 300;">Cargando tus citas...</p>
                    </div>
                </div>

                <!-- Quick Actions -->
                <h3
                    style="margin-bottom: 25px; font-family: var(--font-display); font-size: 1.5rem; color: var(--white); letter-spacing: 1px;">
                    Acciones Rápidas</h3>
                <div class="dashboard-grid">
                    <div class="card" style="cursor: pointer; display: flex; align-items: center; gap: 20px;"
                        onclick="switchTab('reservas')">
                        <div class="icon-box"
                            style="background: rgba(255,255,255,0.05); color: var(--green-glow); width: 60px; height: 60px; font-size: 1.5rem;">
                            <i class="fa-solid fa-calendar-plus"></i>
                        </div>
                        <div>
                            <h4 style="color: var(--white); font-size: 1.2rem; margin-bottom: 5px;">Reservar Cita</h4>
                            <p style="color: #888; font-size: 0.9rem; margin: 0;">Agenda tu próximo entrenamiento 1:1.
                            </p>
                        </div>
                        <i class="fa-solid fa-arrow-right" style="margin-left: auto; color: var(--gray-light);"></i>
                    </div>

                    <div class="card" style="cursor: pointer; display: flex; align-items: center; gap: 20px;"
                        onclick="switchTab('planes')">
                        <div class="icon-box"
                            style="background: rgba(255,255,255,0.05); color: var(--green-glow); width: 60px; height: 60px; font-size: 1.5rem;">
                            <i class="fa-solid fa-repeat"></i>
                        </div>
                        <div>
                            <h4 style="color: var(--white); font-size: 1.2rem; margin-bottom: 5px;">Renovar Bono</h4>
                            <p style="color: #888; font-size: 0.9rem; margin: 0;">Gestiona tu membresía o suscripción.
                            </p>
                        </div>
                        <i class="fa-solid fa-arrow-right" style="margin-left: auto; color: var(--gray-light);"></i>
                    </div>
                </div>
            </div>

            <!-- PLANES Tab -->
            <div id="planes" class="section-content">
                <div class="top-bar">
                    <button class="mobile-menu-btn" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></button>
                    <div>
                        <h1 class="page-title">Planes Disponibles</h1>
                        <p style="color: var(--gray-light); margin-top: 10px;">Elige el plan que mejor se adapte a tus
                            objetivos.</p>
                    </div>
                </div>

                <div id="planes-grid" class="dashboard-grid">
                    <!-- Injected via JS -->
                </div>
            </div>

            <!-- Placeholders for other tabs -->
            <div id="reservas" class="section-content">
                <!-- Booking Section (Full Width) -->
                <div class="top-bar">
                    <button class="mobile-menu-btn" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></button>
                    <div>
                        <h1 class="page-title">Reservar Sesión</h1>
                        <p style="color: var(--gray-light); margin-top: 5px;">Diseña tu semana de entrenamiento.</p>
                    </div>
                </div>

                <div class="bookings-container-full">

                    <!-- 1. Trainers Selection (Full Width) -->
                    <div class="card">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                            <h3 style="color: white; font-family: var(--font-display); margin: 0;">1. Elige Entrenador
                            </h3>

                            <!-- Filters -->
                            <div class="filters-container" style="margin-bottom: 0;">
                                <div class="skills-scroll">
                                    <button class="skill-pill active"
                                        onclick="filterTrainers('all', this)">Todos</button>
                                    <button class="skill-pill" onclick="filterTrainers('Fuerza', this)">Fuerza</button>
                                    <button class="skill-pill" onclick="filterTrainers('Yoga', this)">Yoga</button>
                                    <button class="skill-pill" onclick="filterTrainers('HIIT', this)">HIIT</button>
                                    <button class="skill-pill" onclick="filterTrainers('Boxeo', this)">Boxeo</button>
                                </div>
                            </div>
                        </div>

                        <div id="trainers-grid" class="trainers-grid">
                            <!-- Injected via JS -->
                        </div>
                    </div>

                    <!-- 2. Calendar (Strict Grid 7x5, Full Width) -->
                    <div class="card" style="background: var(--bg-darker); border: 1px solid var(--border-glass);">
                        <h3 style="color: white; font-family: var(--font-display); margin-bottom: 25px;">2. Fecha y Hora
                        </h3>

                        <div class="calendar-wrapper" style="width: 100%; max-width: 800px; margin: 0 auto;">
                            <div class="calendar-header"
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 0 10px;">
                                <button onclick="changeMonth(-1)"
                                    style="background:none; border:none; color:white; cursor:pointer; font-size: 1.2rem;"><i
                                        class="fa-solid fa-chevron-left"></i></button>
                                <span id="calendar-month-year"
                                    style="font-size: 1.5rem; font-weight: 600; font-family: var(--font-display); letter-spacing: 1px;">Febrero
                                    2026</span>
                                <button onclick="changeMonth(1)"
                                    style="background:none; border:none; color:white; cursor:pointer; font-size: 1.2rem;"><i
                                        class="fa-solid fa-chevron-right"></i></button>
                            </div>

                            <!-- Weekdays -->
                            <div class="calendar-grid"
                                style="margin-bottom: 15px; grid-template-columns: repeat(7, 1fr); text-align: center; color: #666; font-size: 0.9rem; font-weight: 600;">
                                <div>LUN</div>
                                <div>MAR</div>
                                <div>MIÉ</div>
                                <div>JUE</div>
                                <div>VIE</div>
                                <div>SÁB</div>
                                <div>DOM</div>
                            </div>

                            <!-- Days Grid -->
                            <div id="calendar-days" class="calendar-grid"
                                style="grid-template-columns: repeat(7, 1fr); gap: 10px;">
                                <!-- Injected via JS -->
                            </div>
                        </div>

                        <!-- Time Slots (Hidden by default) -->
                        <div id="time-selection-area"
                            style="display: none; margin-top: 50px; text-align: center; border-top: 1px solid var(--border-glass); padding-top: 40px;">
                            <h4 style="color: white; margin-bottom: 25px; font-weight: 300; font-size: 1.2rem;">Horarios
                                para <span id="selected-date-display"
                                    style="color: var(--green-glow); font-weight: 700;"></span></h4>

                            <div id="slots-grid">
                                <!-- Injected JS -->
                            </div>

                            <button id="btn-confirm" class="btn btn-primary"
                                style="width: 100%; max-width: 300px; padding: 15px; font-size: 1.1rem; margin-top: 30px;"
                                onclick="confirmBooking()">CONFIRMAR RESERVA</button>
                        </div>
                    </div>

                </div>
            </div> <!-- Closes #reservas correctly -->

            <div id="pagos" class="section-content">
                <div class="top-bar">
                    <button class="mobile-menu-btn" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></button>
                    <h1 class="page-title">Facturación</h1>
                </div>
                <div class="card"
                    style="min-height: 400px; display: flex; align-items: center; justify-content: center; flex-direction: column;">
                    <i class="fa-solid fa-file-invoice-dollar"
                        style="font-size: 3rem; color: var(--gray-light); margin-bottom: 20px; opacity: 0.3;"></i>
                    <p style="color: var(--gray-text); text-align: center;">Historial de Pagos</p>
                    <span style="font-size: 0.8rem; color: #555;">(Se integrará con Stripe/Redsys)</span>
                </div>
            </div>

            <div id="perfil" class="section-content">
                <div class="top-bar">
                    <button class="mobile-menu-btn" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></button>
                    <h1 class="page-title">Mi Perfil</h1>
                </div>
                <div class="card">
                    <h3 style="color: white; font-family: var(--font-display); margin-bottom: 20px;">Datos Personales
                    </h3>
                    <div style="display: grid; gap: 20px; color: #aaa;">
                        <div style="padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                            <label style="display: block; font-size: 0.8rem; margin-bottom: 5px;">Nombre
                                Completo</label>
                            <div id="profile-name" style="color: white; font-size: 1.1rem;">Cargando...</div>
                        </div>
                        <div style="padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                            <label style="display: block; font-size: 0.8rem; margin-bottom: 5px;">Email</label>
                            <div id="profile-email" style="color: white; font-size: 1.1rem;">Cargando...</div>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <div id="booking-toast" class="toast">
        <i class="fa-solid fa-check-circle" style="color: var(--green-glow); font-size: 1.2rem;"></i>
        <span>Reserva confirmada. ¡Nos vemos en el club!</span>
    </div>

    <script type="module">
        import {
            onAuthChange,
            logout,
            getEntrenadores,
            getPlanes,
            getPerfilUsuario,
            crearReserva,
            getProximaReserva,
            getReservasUsuario,
            activarPlan,
            cancelarReserva,
            seedEntrenadores,
            seedPlanes,
            getUsuarioActual,
            listenOcupacion
        } from './firebase.js';

        // Estado global (ahora se llena desde Firebase)
        let currentUserProfile = null;
        let dbTrainers = [];
        let unsubscribeOccupancy = null;
        window.currentDateReservas = [];

        // Expose to window so global handlers can use them
        window.getUsuarioActual = getUsuarioActual;

        // ─── INITIALIZATION ───
        async function initData(user) {
            console.log('[Dashboard] Starting initData for user:', user.uid);
            try {
                // 1. Seed data
                // 1. Seed data (Running for population)
                console.log('[Dashboard] Seeding data...');
                await seedEntrenadores();
                await seedPlanes();

                // 2. Load Profile
                console.log('[Dashboard] Loading profile...');
                currentUserProfile = await getPerfilUsuario(user.uid);
                console.log('[Dashboard] Profile loaded:', currentUserProfile);

                if (!currentUserProfile) {
                    console.warn('[Dashboard] Profile is null/undefined!');
                }

                updateProfileUI(user, currentUserProfile);

                // 3. Load Trainers
                console.log('[Dashboard] Loading trainers...');
                dbTrainers = await getEntrenadores();
                renderTrainers(dbTrainers);

                // 4. Load Next Session & List
                console.log('[Dashboard] Loading next session...');
                const nextReserva = await getProximaReserva();
                updateNextSessionUI(nextReserva);

                const allReservas = await getReservasUsuario();
                renderMisCitas(allReservas);

                // 5. Load Plans
                console.log('[Dashboard] Loading plans...');
                const planes = await getPlanes();
                renderPlanes(planes);

                console.log('[Dashboard] Init complete!');

                const overlay = document.getElementById('loadingOverlay');
                if (overlay) {
                    overlay.style.opacity = '0';
                    setTimeout(() => overlay.style.display = 'none', 500);
                }

            } catch (err) {
                console.error('[Dashboard] Error init data:', err);
                const overlay = document.getElementById('loadingOverlay');
                if (overlay) {
                    overlay.innerHTML = `<div style="padding: 20px; color: #ff5555; text-align: center;">
                        <h2 style="margin-bottom: 20px; font-weight: 300;">ERROR DE CARGA</h2>
                        <p style="margin-bottom: 20px; color: #ccc;">${err.message}</p>
                        <button onclick="window.location.reload()" style="padding: 12px 24px; background: var(--green-glow); color: black; border: none; border-radius: 4px; font-weight: bold; cursor: pointer;">REINTENTAR</button>
                    </div>`;
                }
            }
        }

        // ─── UI UPDATES ───
        function updateProfileUI(authData, profileData) {
            // Sidebar & Header
            const displayName = profileData?.nombre || authData.displayName || authData.email.split('@')[0];
            const initials = displayName.split(' ').map(w => w[0]).join('').toUpperCase().slice(0, 2);

            // Sidebar
            const avatarEl = document.getElementById('userAvatar');
            if (avatarEl) avatarEl.textContent = initials;
            const nameEl = document.getElementById('userName');
            if (nameEl) nameEl.textContent = displayName;

            // Welcome Header
            document.querySelector('.page-title').textContent = displayName;

            // Stats
            const plan = profileData?.plan_activo ? formatPlanName(profileData.plan_activo) : 'Sin Plan';
            document.querySelector('.stat-value').textContent = plan;

            // Sessions
            const sessionsEl = document.getElementById('sessions-remaining');
            const total = profileData?.sesiones_totales || 0;
            const left = profileData?.sesiones_restantes || 0;
            if (sessionsEl) {
                sessionsEl.innerHTML = `${left} <span style="font-size: 1.5rem; color: #666; font-weight: 300;">/ ${total}</span>`;
            }

            // Perfil Tab
            const profileName = document.getElementById('profile-name');
            const profileEmail = document.getElementById('profile-email');
            if (profileName) profileName.textContent = profileData?.nombre || displayName;
            if (profileEmail) profileEmail.textContent = profileData?.email || authData.email;
        }

        function updateNextSessionUI(reserva) {
            const timeEl = document.getElementById('next-session-time');
            const infoEl = document.getElementById('next-session-info');

            if (!reserva) {
                timeEl.textContent = 'Sin reservas';
                infoEl.innerHTML = '<i class="fa-regular fa-clock" style="margin-right: 5px;"></i> Reserva tu próxima clase';
                return;
            }

            // Formatear fecha
            const date = reserva.fecha_sesion.toDate();
            const dateStr = date.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric' });
            const timeStr = reserva.hora;

            timeEl.textContent = `${dateStr} ${timeStr}`;
            infoEl.innerHTML = `<i class="fa-regular fa-clock" style="margin-right: 5px;"></i> ${reserva.nombre_clase} con ${reserva.entrenador_nombre}`;
        }

        function formatPlanName(slug) {
            // Simple formatter
            if (!slug) return 'Sin Plan';
            return slug.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
        }

        // ─── TRAINERS RENDER (Override global function) ───
        window.renderTrainers = function (list = dbTrainers) {
            const grid = document.getElementById('trainers-grid');
            if (!grid) return;
            grid.innerHTML = '';

            // Add "Any" option logic if needed, or just list real trainers
            // Let's add the "Cualquier Entrenador" manually as first option
            const anyOption = { id: 'any', nombre: 'Cualquier Entrenador', rol: 'Asignación auto', especialidades: [], foto_url: 'https://images.unsplash.com/photo-1517836357463-d25dfeac3438?w=100' };
            const fullList = [anyOption, ...list];

            fullList.forEach(trainer => {
                // Filter logic
                const hasSkill = trainer.especialidades && trainer.especialidades.includes(window.currentFilter);
                if (window.currentFilter !== 'all' && !hasSkill && trainer.id !== 'any') return;

                const card = document.createElement('div');
                card.className = `trainer-card ${window.selectedTrainerId === trainer.id ? 'selected' : ''}`;
                card.onclick = () => window.selectTrainer(trainer.id);

                const skillsHtml = (trainer.especialidades || []).map(s => `<span class="skill-badge">${s}</span>`).join('');
                const isAny = trainer.id === 'any';

                card.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <img src="${trainer.foto_url}" class="trainer-img" style="${isAny ? 'filter: grayscale(1);' : ''}">
                        <div>
                            <h4 style="color: white; margin: 0 0 4px 0;">${trainer.nombre}</h4>
                            <p style="color: #888; font-size: 0.8rem; margin: 0;">${trainer.rol}</p>
                        </div>
                    </div>
                    <div style="margin-top: 10px;">
                        ${isAny ? '<span style="font-size: 0.8rem; color: #666;">Selección basada en filtro</span>' : skillsHtml}
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // ─── PLANS RENDER ───
        window.renderPlanes = function (list) {
            const grid = document.getElementById('planes-grid');
            if (!grid) return;
            grid.innerHTML = '';

            list.forEach(plan => {
                const isPopular = plan.popular;
                const card = document.createElement('div');
                card.className = `plan-card ${isPopular ? 'popular' : ''}`;

                card.innerHTML = `
                        <div class="plan-image" style="background-image: url('${plan.imagen_url}');">
                            ${isPopular ? '<div class="popular-badge">Más Popular</div>' : ''}
                        </div>
                        <div class="plan-content">
                            <h3 class="plan-title">${plan.nombre}</h3>
                            <p class="plan-desc">${plan.descripcion}</p>

                            <div class="plan-price-row">
                                <span class="price-current">${plan.precio.toFixed(2).replace('.', ',')} €</span>
                                ${plan.precio_original ? `<span class="price-original">${plan.precio_original.toFixed(2).replace('.', ',')} €</span>` : ''}
                            </div>

                            <button class="btn btn-plan" style="${isPopular ? 'background: var(--green-glow); color: black; border-color: var(--green-glow);' : ''}" onclick="selectPlan('${plan.id}')">
                                ${isPopular ? 'Seleccionar Bono' : 'Seleccionar Plan'}
                            </button>
                        </div>
                `;
                grid.appendChild(card);
            });
        }

        window.selectPlan = async function (planId) {
            if (!currentUserProfile) return;

            if (confirm("¿Confirmar cambio de plan? Esto actualizará tus sesiones disponibles.")) {
                try {
                    const btn = event.target;
                    const originalText = btn.innerText;
                    btn.innerText = "Procesando...";
                    btn.disabled = true;

                    await activarPlan(currentUserProfile.uid, planId);

                    // Refresh Profile
                    currentUserProfile = await getPerfilUsuario(currentUserProfile.uid);
                    updateProfileUI(getUsuarioActual(), currentUserProfile);

                    alert("¡Plan activado correctamente!");
                    window.switchTab('inicio');
                } catch (err) {
                    console.error(err);
                    alert("Error activando plan: " + err.message);
                } finally {
                    // Restore button if we didn't navigate away (or if error)
                    const btns = document.querySelectorAll('.btn-plan');
                    btns.forEach(b => { b.disabled = false; b.innerText = b.innerText === "Procesando..." ? "Seleccionar" : b.innerText; });
                    // Note: simplistic restore, real app might be more specific
                }
            }
        }

        // ─── BOOKING LOGIC (Connect to Firestore) ───
        window.confirmBooking = async function () {
            if (!window.selectedTrainerId) { alert("Elige un entrenador primero."); return; }
            if (!window.selectedDate || !window.selectedTime) { alert("Por favor selecciona día y hora."); return; }

            if (!currentUserProfile || currentUserProfile.sesiones_restantes <= 0) {
                alert("Sin sesiones disponibles. Por favor renueva tu bono.");
                window.switchTab('planes');
                return;
            }

            // Resolve Trainer
            let assignedTrainer = dbTrainers.find(t => t.id === window.selectedTrainerId);
            // Logic for "any" -> pick random matching filter
            if (window.selectedTrainerId === 'any') {
                // Simple logic: pick first available or random
                const validTrainers = dbTrainers.filter(t => window.currentFilter === 'all' || t.especialidades.includes(window.currentFilter));
                if (validTrainers.length > 0) {
                    assignedTrainer = validTrainers[Math.floor(Math.random() * validTrainers.length)];
                }
            }

            if (!assignedTrainer) {
                alert("Error asignando entrenador. Intenta de nuevo.");
                return;
            }

            // Create Date Object
            const bookingDate = new Date(window.selectedDate.year, window.selectedDate.month, window.selectedDate.day);

            try {
                // Show loading/optimistic UI
                const btn = document.getElementById('btn-confirm');
                const originalText = btn.innerText;
                btn.innerText = "Confirmando...";
                btn.disabled = true;

                // Call Firestore
                await crearReserva({
                    entrenador_id: assignedTrainer.id,
                    entrenador_nombre: assignedTrainer.nombre,
                    fecha_sesion: bookingDate,
                    hora: window.selectedTime,
                    nombre_clase: window.currentFilter === 'all' ? 'Entrenamiento' : window.currentFilter
                });

                // Update Local State & UI
                currentUserProfile.sesiones_restantes--;
                updateProfileUI(getUsuarioActual(), currentUserProfile);

                // Refresh Next Session & List
                const nextReserva = await getProximaReserva();
                updateNextSessionUI(nextReserva);

                const allReservas = await getReservasUsuario();
                renderMisCitas(allReservas);

                window.showToast("Reserva confirmada");
                window.switchTab('inicio');

                // Reset Selection
                window.selectedTrainerId = null;
                window.selectedDate = null;
                window.selectedTime = null;
                window.renderTrainers();
                window.renderCalendar();
                document.getElementById('time-selection-area').style.display = 'none';

                btn.innerText = originalText;
                btn.disabled = false;

            } catch (err) {
                console.error(err);
                let message = "Error al reservar: " + err.message;

                if (err.message === 'YA_TIENES_CITA') {
                    message = 'Ya tienes una reserva confirmada a esta misma hora.\nPor favor, elige otro horario.';
                } else if (err.message === 'SESION_LLENA') {
                    message = 'Lo sentimos, esta sesión acaba de completarse.\nPor favor, elige otro entrenador o un horario diferente.';
                } else if (err.message === 'FECHA_PASADA') {
                    message = 'No puedes reservar una sesión en el pasado.';
                } else if (err.message === 'SIN_SESIONES') {
                    message = 'No tienes sesiones disponibles. Por favor renueva tu bono.';
                }

                alert(message);

                document.getElementById('btn-confirm').innerText = "CONFIRMAR RESERVA";
                document.getElementById('btn-confirm').disabled = false;
            }
        }

        // ─── RESERVATIONS LIST RENDER ───
        window.renderMisCitas = function (reservas) {
            const container = document.getElementById('mis-citas-container');
            if (!container) return;

            if (!reservas || reservas.length === 0) {
                container.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; text-align: center; color: rgba(255,255,255,0.3); padding: 60px 20px; background: rgba(255,255,255,0.01); border: 1px solid rgba(255,255,255,0.03); border-radius: 16px; min-height: 150px;">
                        <p style="margin: 0; font-size: 0.95rem; font-weight: 300; letter-spacing: 0.5px;">No tienes citas programadas.</p>
                    </div>`;
                return;
            }

            container.innerHTML = '';
            // Show only upcoming (or recent)? User asked for list. Let's show all but highlight upcoming.
            // Actually user said "Mis Citas... Al hacer clic...".
            // Let's sort by date descending (already done in query).

            reservas.forEach(reserva => {
                const date = reserva.fecha_sesion.toDate();
                // FIX: Combine Date + Time for accurate comparison
                const [h, m] = reserva.hora.split(':').map(Number);
                date.setHours(h, m, 0, 0);

                const now = new Date();
                const isPast = date < now;
                const isCancelled = reserva.estado === 'cancelada';

                const days = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
                const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                const dateStr = `${days[date.getDay()]} ${date.getDate()} ${months[date.getMonth()]}`;

                const card = document.createElement('div');
                card.className = 'cita-card';
                if (isCancelled) card.style.opacity = '0.5';

                let actionBtn = '';
                if (!isPast && !isCancelled) {
                    actionBtn = `<button class="btn-cancel" onclick="handleCancelar('${reserva.id}')">Cancelar</button>`;
                } else if (isCancelled) {
                    actionBtn = `<span style="color: #f44336; font-size: 0.8rem;">Cancelada</span>`;
                } else {
                    actionBtn = `<span style="color: #666; font-size: 0.8rem;">Completada</span>`;
                }

                card.innerHTML = `
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 10px; text-align: center; min-width: 60px;">
                            <div style="font-weight: 700; font-size: 1.1rem; color: var(--white);">${date.getDate()}</div>
                            <div style="font-size: 0.75rem; text-transform: uppercase; color: var(--gray-light);">${months[date.getMonth()]}</div>
                        </div>
                        <div>
                            <div style="color: var(--white); font-weight: 600; font-size: 1rem;">${reserva.nombre_clase}</div>
                            <div class="cita-info">
                                <i class="fa-regular fa-clock" style="margin-right: 5px;"></i> ${reserva.hora} 
                                <span style="margin: 0 5px;">•</span> 
                                <i class="fa-solid fa-user-ninja" style="margin-right: 5px;"></i> ${reserva.entrenador_nombre}
                            </div>
                        </div>
                    </div>
                    <div>${actionBtn}</div>
                `;
                container.appendChild(card);
            });
        }

        window.handleCancelar = async function (reservaId) {
            if (!confirm("¿Seguro que quieres cancelar esta cita? Te devolveremos la sesión.")) return;

            try {
                // Optimistic update? Better wait.
                await cancelarReserva(reservaId);

                // Refresh data
                currentUserProfile = await getPerfilUsuario(currentUserProfile.uid);
                updateProfileUI(getUsuarioActual(), currentUserProfile);

                const nextReserva = await getProximaReserva();
                updateNextSessionUI(nextReserva);

                const allReservas = await getReservasUsuario();
                renderMisCitas(allReservas);

                window.showToast("Cita cancelada. Sesión devuelta.");
            } catch (e) {
                console.error(e);
                let message = "Error al cancelar: " + e.message;
                if (e.message === 'LIMITE_CANCELACION_EXCEDIDO') {
                    message = 'No se puede cancelar la cita con menos de 2 horas de antelación.';
                }
                alert(message);
            }
        }

        // ─── AUTH GUARD ───
        // ─── AUTH GUARD ───
        // Show loading state by default (overlay is in HTML)

        onAuthChange((user) => {
            if (user) {
                console.log('[Dashboard] User authenticated:', user.uid);
                initData(user);
            } else {
                console.warn('[Dashboard] No user found. Waiting...');
                // STOP AUTOMATIC REDIRECT to debug loop
                // window.location.href = './login.html';

                const overlay = document.getElementById('loadingOverlay');
                if (overlay) {
                    overlay.innerHTML = `
                        <div style="text-align:center; padding:20px; color:white;">
                            <h2>Sesión no detectada</h2>
                            <p style="color:#aaa; margin:10px 0;">Firebase no encuentra tu usuario aquí.</p>
                            <p><small>v2.6 Fixed</small></p>
                            <button onclick="window.location.href='./login.html'" style="padding:10px 20px; background:var(--green-glow); border:none; font-weight:bold; cursor:pointer;">
                                Volver al Login
                            </button>
                        </div>
                    `;
                    overlay.style.opacity = '1';
                }
            }
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', async (e) => {
            e.preventDefault();
            await logout();
            window.location.href = './login.html';
        });

        // Global functions needed for HTML events
        // Note: Functions defined in module are not global. We must attach them to window.

        window.filterTrainers = function (skill, btnElement) {
            window.currentFilter = skill;
            document.querySelectorAll('.skill-pill').forEach(el => el.classList.remove('active'));
            btnElement.classList.add('active');
            window.renderTrainers();
        }

        window.selectTrainer = function (id) {
            window.selectedTrainerId = id;
            window.renderTrainers();
            if (window.selectedDate) window.generateTimeSlots();
        }

        window.switchTab = function (tabId, navElement) {
            document.querySelectorAll('.section-content').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            if (!navElement) navElement = document.getElementById('nav-' + tabId);
            if (navElement) {
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                navElement.classList.add('active');
            }
        }

        window.toggleSidebar = function () {
            document.querySelector('.sidebar').classList.toggle('active');
            document.querySelector('.sidebar-overlay').classList.toggle('active');
        }

        window.closeSidebar = function () {
            if (window.innerWidth <= 768) {
                document.querySelector('.sidebar').classList.remove('active');
                document.querySelector('.sidebar-overlay').classList.remove('active');
            }
        }

        // Calendar Helper (re-implementation of light logic)
        window.renderCalendar = function () {
            const grid = document.getElementById('calendar-days');
            const monthYearEl = document.getElementById('calendar-month-year');
            const months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

            monthYearEl.innerText = `${months[window.currentCalendarMonth]} ${window.currentCalendarYear}`;
            grid.innerHTML = '';

            const firstDay = new Date(window.currentCalendarYear, window.currentCalendarMonth, 1).getDay();
            const daysInMonth = new Date(window.currentCalendarYear, window.currentCalendarMonth + 1, 0).getDate();
            const startingEmpty = firstDay === 0 ? 6 : firstDay - 1;

            for (let i = 0; i < startingEmpty; i++) { const empty = document.createElement('div'); grid.appendChild(empty); }

            const demoToday = new Date();
            demoToday.setHours(0, 0, 0, 0);

            for (let i = 1; i <= daysInMonth; i++) {
                const dayDate = new Date(window.currentCalendarYear, window.currentCalendarMonth, i);
                const dayEl = document.createElement('div');
                dayEl.classList.add('calendar-day');
                dayEl.innerText = i;

                if (dayDate < demoToday) {
                    dayEl.classList.add('disabled-past');
                } else {
                    dayEl.onclick = () => window.selectDay(i, dayEl);
                }

                if (window.selectedDate && window.selectedDate.day === i && window.selectedDate.month === window.currentCalendarMonth) {
                    dayEl.classList.add('selected');
                }
                grid.appendChild(dayEl);
            }
        }

        window.changeMonth = function (delta) {
            window.currentCalendarMonth += delta;
            if (window.currentCalendarMonth > 11) { window.currentCalendarMonth = 0; window.currentCalendarYear++; }
            if (window.currentCalendarMonth < 0) { window.currentCalendarMonth = 11; window.currentCalendarYear--; }
            window.renderCalendar();
        }

        window.selectDay = function (day, el) {
            console.log('[Booking] Day selected:', day);
            document.querySelectorAll('.calendar-day').forEach(d => d.classList.remove('selected'));
            el.classList.add('selected');
            window.selectedDate = { day, month: window.currentCalendarMonth, year: window.currentCalendarYear };

            const dateObj = new Date(window.currentCalendarYear, window.currentCalendarMonth, day);
            const dateString = dateObj.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
            document.getElementById('selected-date-display').innerText = dateString.charAt(0).toUpperCase() + dateString.slice(1);

            const timeArea = document.getElementById('time-selection-area');
            timeArea.style.display = 'block';
            window.selectedTime = null;

            // Optional: Scroll to time area on mobile
            if (window.innerWidth < 768) {
                timeArea.scrollIntoView({ behavior: 'smooth' });
            }

            // Fallback: clear the grid immediately so it doesn't show old data
            window.currentDateReservas = [];
            window.generateTimeSlots();

            // REAL-TIME LISTENER for the selected day
            if (unsubscribeOccupancy) unsubscribeOccupancy();
            try {
                unsubscribeOccupancy = listenOcupacion(dateObj, (reservas) => {
                    console.log('[Booking] Real-time update for day:', day, 'Reservas count:', reservas.length);
                    window.currentDateReservas = reservas;
                    window.generateTimeSlots();
                });
            } catch (err) {
                console.error('[Booking] Error setting up listener:', err);
                // Fallback rendering
                window.generateTimeSlots();
            }
        }

        window.generateTimeSlots = function () {
            console.log('[Booking] generateTimeSlots called. selectedTrainerId:', window.selectedTrainerId);
            const container = document.getElementById('slots-grid');
            if (!container) return;
            container.innerHTML = '';

            const times = ["09:00", "10:00", "11:00", "12:00", "16:00", "17:00", "18:00", "19:00", "20:00"];
            const now = new Date();
            const user = typeof getUsuarioActual === 'function' ? getUsuarioActual() : null;
            const userId = user ? user.uid : null;

            const isToday = window.selectedDate &&
                window.selectedDate.day === now.getDate() &&
                window.selectedDate.month === now.getMonth() &&
                window.selectedDate.year === now.getFullYear();

            times.forEach(time => {
                const btn = document.createElement('button');
                btn.className = 'time-slot';

                // 1. Past check
                let isPast = false;
                if (isToday) {
                    const [h, m] = time.split(':');
                    const slotTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), parseInt(h), parseInt(m));
                    if (slotTime < now) isPast = true;
                }

                // 2. Data check
                const resArray = window.currentDateReservas || [];
                const reservasHora = resArray.filter(r => r.hora === time);
                const ocupadaPorMi = userId ? reservasHora.find(r => r.uid_usuario === userId) : null;
                const ocupadaGlobal = (window.selectedTrainerId && window.selectedTrainerId !== 'any')
                    ? reservasHora.find(r => r.entrenador_id === window.selectedTrainerId)
                    : null;

                if (isPast) {
                    btn.classList.add('disabled-past');
                    btn.style.opacity = '0.3';
                    btn.innerText = time;
                    btn.disabled = true;
                } else if (ocupadaPorMi) {
                    btn.classList.add('user-booked');
                    btn.innerHTML = `${time} <span style="font-size:0.6rem; display:block; opacity:0.8;">RESERVADO</span>`;
                    btn.disabled = true;
                } else if (ocupadaGlobal) {
                    btn.classList.add('full');
                    btn.innerHTML = `${time} <span style="font-size:0.6rem; display:block; opacity:0.8;">COMPLETO</span>`;
                    btn.disabled = true;
                } else {
                    btn.innerText = time;
                    btn.onclick = () => {
                        document.querySelectorAll('.time-slot').forEach(b => b.classList.remove('selected'));
                        btn.classList.add('selected');
                        window.selectedTime = time;
                    };
                }

                if (window.selectedTime === time && !btn.disabled) {
                    btn.classList.add('selected');
                }

                container.appendChild(btn);
            });
            console.log('[Booking] generateTimeSlots finished. Slots added:', container.children.length);
        }

        window.showToast = function (message) {
            const toast = document.getElementById('booking-toast');
            toast.querySelector('span').innerText = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 4000);
        }

        // Global state vars
        window.currentFilter = 'all';
        window.selectedTrainerId = null;
        window.selectedDate = null;
        window.selectedTime = null;
        window.currentCalendarMonth = new Date().getMonth();
        window.currentCalendarYear = new Date().getFullYear();

        // Init Calendar
        document.addEventListener('DOMContentLoaded', () => {
            window.renderCalendar();
        });

    </script>
</body>

</html>